async function ValidarGEOAPI() {
    const loadingModal = document.getElementById('loadin    addresses.forEach(({id, address, postalCode, streetName}) => {
            const result = data.results[id];
            const row = document.querySelector(`tr[data-id="${id}"]`);
            const enderecoInput = row.querySelector('input[data-field="endereco"]');
            
            if (result.is_valid) {
                validCount++;
                // Adiciona classes de sucesso
                enderecoInput.classList.remove('border-red-500', 'bg-red-50');
                enderecoInput.classList.add('border-green-500', 'bg-green-50');
                
                // Adiciona tooltip com informações da validação
                enderecoInput.title = `Endereço validado✓\nRua: ${result.matching_street || 'N/A'}\nCódigo Postal: ${postalCode || 'N/A'}\nConfiança: ${Math.round(result.confidence * 100)}%`; loadingModal.classList.remove('hidden');
    
    try {
        // Coleta todos os endereços e extrai códigos postais
        const addresses = [];
        const rows = document.querySelectorAll('#corpo-tabela tr');
        const invalidPostalCodes = [];
        
        rows.forEach(row => {
            const enderecoInput = row.querySelector('input[data-field="endereco"]');
            if (enderecoInput) {
                const fullAddress = enderecoInput.value;
                const postalCodeMatch = fullAddress.match(/\b\d{4}-\d{3}\b|\b\d{4}\b/);
                const streetName = fullAddress.split(/\d{4}-\d{3}|\d{4}/)[0].trim();
                const postalCode = postalCodeMatch ? postalCodeMatch[0] : null;
                
                addresses.push({
                    id: row.getAttribute('data-id'),
                    address: fullAddress,
                    postalCode: postalCode,
                    streetName: streetName
                });

                if (!postalCode) {
                    invalidPostalCodes.push({
                        id: row.getAttribute('data-id'),
                        address: fullAddress
                    });
                }
            }
        });

        // Verifica se há endereços sem código postal
        if (invalidPostalCodes.length > 0) {
            throw new Error(`${invalidPostalCodes.length} endereço(s) sem código postal válido:\n${
                invalidPostalCodes.map(a => `#${a.id}: ${a.address}`).join('\n')
            }`);
        }

        // Faz a requisição para a API de validação
        console.log('Enviando requisição com dados:', {
            addresses: addresses.map(a => a.address),
            token: window.GEOAPI_TOKEN ? 'Present' : 'Missing'
        });

        const response = await fetch('/converter/validate-addresses/', {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ 
                addresses: addresses.map(a => ({
                    address: a.address,
                    postalCode: a.postalCode,
                    streetName: a.streetName
                })),
                token: window.GEOAPI_TOKEN
            })
        });

        console.log('Status da resposta:', response.status);
        console.log('Headers da resposta:', Object.fromEntries(response.headers.entries()));

        const responseText = await response.text();
        console.log('Resposta bruta:', responseText);

        let data;
        try {
            data = JSON.parse(responseText);
        } catch (e) {
            console.error('Erro ao parsear JSON:', e);
            console.error('Conteúdo que causou erro:', responseText);
            throw new Error(`Erro ao parsear resposta do servidor: ${e.message}`);
        }

        if (!data.success) {
            console.error('Resposta com erro:', data);
            throw new Error(data.error || 'Erro ao validar endereços');
        }

        // Processa os resultados
        let validCount = 0;
        let invalidCount = 0;
        const invalidAddresses = [];

        addresses.forEach(({id, address}) => {
            const result = data.results[address];
            const row = document.querySelector(`tr[data-id="${id}"]`);
            const enderecoInput = row.querySelector('input[data-field="endereco"]');
            
            if (result.is_valid) {
                validCount++;
                // Adiciona classes de sucesso
                enderecoInput.classList.remove('border-red-500', 'bg-red-50');
                enderecoInput.classList.add('border-green-500', 'bg-green-50');
                
                // Adiciona tooltip com informações da validação
                enderecoInput.title = `Endereço validado✓\nRua correspondente: ${result.matching_street || 'N/A'}\nConfiança: ${Math.round(result.confidence * 100)}%`;
                
                // Adiciona coordenadas como data attributes
                if (result.coordinates) {
                    row.setAttribute('data-lat', result.coordinates[0]);
                    row.setAttribute('data-lng', result.coordinates[1]);
                }
                
                // Se tiver um endereço validado diferente, sugere a correção
                if (result.validated_address && result.validated_address !== address) {
                    const suggestButton = document.createElement('button');
                    suggestButton.className = 'ml-2 text-blue-500 hover:text-blue-700';
                    suggestButton.innerHTML = '<i class="bi bi-arrow-clockwise"></i>';
                    suggestButton.title = `Sugerir: ${result.validated_address}`;
                    suggestButton.onclick = () => {
                        enderecoInput.value = result.validated_address;
                        suggestButton.remove();
                    };
                    enderecoInput.parentNode.appendChild(suggestButton);
                }
            } else {
                invalidCount++;
                // Adiciona classes de erro
                enderecoInput.classList.remove('border-green-500', 'bg-green-50');
                enderecoInput.classList.add('border-red-500', 'bg-red-50');
                
                invalidAddresses.push({
                    id,
                    address,
                    error: result.error || 'Endereço não validado',
                    confidence: result.confidence
                });
            }
        });

        // Mostra o modal com o resultado
        showValidationResults({
            total: addresses.length,
            valid: validCount,
            invalid: invalidCount,
            invalidAddresses
        });

    } catch (error) {
        console.error('Erro ao validar endereços:', error);
        alert(`Erro ao validar endereços: ${error.message}`);
    } finally {
        loadingModal.classList.add('hidden');
    }
}

function showValidationResults(results) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
    modal.innerHTML = `
        <div class="bg-white rounded-xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-medium text-gray-900">Relatório de Validação de Endereços</h3>
                <button onclick="this.closest('.fixed').remove()" 
                        class="text-gray-400 hover:text-gray-500">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            
            <!-- Sumário -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="bg-gray-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-gray-700">${results.total}</div>
                    <div class="text-sm text-gray-500">Total de Endereços</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-green-700">${results.valid}</div>
                    <div class="text-sm text-green-500">Endereços Válidos</div>
                </div>
                <div class="bg-red-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-red-700">${results.invalid}</div>
                    <div class="text-sm text-red-500">Endereços Inválidos</div>
                </div>
            </div>

            ${results.invalid > 0 ? `
                <!-- Lista de endereços inválidos -->
                <div class="mt-6">
                    <h4 class="text-lg font-medium text-gray-900 mb-4">Endereços que Precisam de Atenção</h4>
                    <div class="bg-white shadow overflow-hidden rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Endereço</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Problema</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${results.invalidAddresses.map(item => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">#${item.id}</td>
                                        <td class="px-6 py-4 text-sm text-gray-900">${item.address}</td>
                                        <td class="px-6 py-4 text-sm text-red-500">${item.error}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            ` : ''}

            <!-- Ações -->
            <div class="mt-6 flex justify-end space-x-4">
                <button onclick="this.closest('.fixed').remove()" 
                        class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                    Fechar
                </button>
                ${results.invalid === 0 ? `
                    <button onclick="gerarXLSX()" 
                            class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600">
                        Continuar com XLSX
                    </button>
                ` : ''}
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Função helper para pegar o token CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
