{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversor de Lista para XLSX</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="{% static 'js/geoapivalidator.js' %}"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                            950: '#082f49',
                        },
                        accent: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            200: '#99f6e4',
                            300: '#5eead4',
                            400: '#2dd4bf',
                            500: '#14b8a6',
                            600: '#0d9488',
                            700: '#0f766e',
                            800: '#115e59',
                            900: '#134e4a',
                            950: '#022c22',
                        }
                    }
                }
            }
        }
    </script>
    <script src="{% static 'js/geoapivalidator.js' %}"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-primary-600 to-primary-800 p-6 text-white">
                <h1 class="text-3xl font-bold text-center">Conversor de Lista para XLSX</h1>
                <p class="mt-2 text-center opacity-80">Processamento inteligente com IA</p>
            </div>

            <div class="p-6">
                <!-- Instruções -->
                <div class="bg-blue-50 border-l-4 border-primary-500 p-5 rounded-lg mb-6">
                    <h3 class="text-xl font-semibold text-primary-700 mb-2">Como usar:</h3>
                    <p class="text-gray-700 mb-4">Cole sua lista no formato texto abaixo. Cada bloco deve começar com "#" e conter os dados em linhas separadas.</p>
                    <div class="bg-white p-4 rounded-lg border border-blue-200 font-mono text-sm overflow-auto">
                        Exemplo:<br>
                        <span class="text-primary-600 font-semibold">#</span>Rua das Flores, 123<br>
                        ID001<br>
                        45<br>
                        14:30<br>
                        2025-08-18<br>
                        Manhã<br>
                        1500<br>
                        3<br><br>
                        <span class="text-primary-600 font-semibold">#</span>Avenida Central, 456<br>
                        ID002<br>
                        78<br>
                        16:45<br>
                        2025-08-18<br>
                        Tarde<br>
                        2000<br>
                        5
                    </div>
                </div>
                
                {% if error %}
                <div class="bg-red-50 border-l-4 border-red-500 p-5 rounded-lg mb-6">
                    <h4 class="text-lg font-semibold text-red-700 mb-2">Erro:</h4>
                    <p class="text-gray-700">{{ error }}</p>
                    {% if debug_info %}
                    <details class="mt-3">
                        <summary class="cursor-pointer text-red-700 font-medium">Detalhes técnicos</summary>
                        <pre class="mt-2 bg-gray-50 p-3 rounded-lg text-xs overflow-x-auto">{{ debug_info }}</pre>
                    </details>
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- Formulário -->
                <form method="post" class="mt-6">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="parse">
                    <textarea 
                        name="lista" 
                        placeholder="Cole sua lista aqui..." 
                        required
                        class="w-full h-96 px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-primary-500 focus:ring focus:ring-primary-200 focus:ring-opacity-50 resize-y font-mono text-sm transition-all duration-200 outline-none"
                    >{% if raw_text %}{{ raw_text }}{% endif %}</textarea>
                    <div class="flex justify-center mt-6">
                        <button 
                            type="submit" 
                            class="bg-primary-600 hover:bg-primary-700 text-white px-8 py-3 rounded-lg font-medium transition-all duration-200 shadow-md hover:shadow-lg flex items-center"
                        >
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                            Processar Lista
                        </button>
                    </div>
                </form>
                
                {% if ai_stats %}
                <div class="mt-8 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-100 p-6">
                    <h3 class="text-xl font-semibold text-primary-700 flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 12v3c0 1.657 3.134 3 7 3s7-1.343 7-3v-3c0 1.657-3.134 3-7 3s-7-1.343-7-3z"></path>
                            <path d="M3 7v3c0 1.657 3.134 3 7 3s7-1.343 7-3V7c0 1.657-3.134 3-7 3S3 8.657 3 7z"></path>
                            <path d="M17 5c0 1.657-3.134 3-7 3S3 6.657 3 5s3.134-3 7-3 7 1.343 7 3z"></path>
                        </svg>
                        Estatísticas da IA
                    </h3>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <div class="flex items-center mb-4">
                                <div class="flex-1">
                                    <p class="text-gray-700">Processamentos realizados:</p>
                                    <span class="font-bold text-primary-600 text-xl">{{ ai_stats.total_history }}</span>
                                </div>
                                
                                {% if ai_stats.accuracy %}
                                <div class="flex flex-col items-center justify-center px-4">
                                    <div class="relative">
                                        <svg class="w-16 h-16">
                                            <circle class="text-gray-200" stroke-width="4" stroke="currentColor" fill="transparent" r="28" cx="32" cy="32"/>
                                            <circle class="text-primary-600" stroke-width="4" stroke="currentColor" fill="transparent" r="28" cx="32" cy="32" 
                                                stroke-dasharray="175.9" stroke-dashoffset="{% widthratio 100|add:"-"|add:ai_stats.accuracy 100 175.9 %}" stroke-linecap="round"/>
                                        </svg>
                                        <div class="absolute inset-0 flex items-center justify-center">
                                            <span class="text-lg font-bold text-primary-700">{{ ai_stats.accuracy|floatformat:0 }}%</span>
                                        </div>
                                    </div>
                                    <span class="text-xs text-gray-500 mt-1">Precisão</span>
                                </div>
                                {% endif %}
                            </div>
                            
                            {% if ai_stats.last_processed %}
                            <div class="text-xs text-gray-500 mt-2">
                                Último processamento: {{ ai_stats.last_processed|date:"d/m/Y H:i" }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <p class="text-gray-700 mb-3">Padrões aprendidos:</p>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="flex flex-col">
                                    <div class="flex items-center mb-2">
                                        <span class="w-3 h-3 bg-primary-400 rounded-full mr-2"></span>
                                        <span class="text-sm flex-1">Endereços:</span>
                                        <span class="font-semibold text-primary-700">{{ ai_stats.patterns.endereco }}</span>
                                    </div>
                                    <div class="flex items-center mb-2">
                                        <span class="w-3 h-3 bg-primary-500 rounded-full mr-2"></span>
                                        <span class="text-sm flex-1">IDs:</span>
                                        <span class="font-semibold text-primary-700">{{ ai_stats.patterns.codigo_id }}</span>
                                    </div>
                                    <div class="flex items-center mb-2">
                                        <span class="w-3 h-3 bg-primary-600 rounded-full mr-2"></span>
                                        <span class="text-sm flex-1">Horas:</span>
                                        <span class="font-semibold text-primary-700">{{ ai_stats.patterns.hora }}</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="w-3 h-3 bg-primary-700 rounded-full mr-2"></span>
                                        <span class="text-sm flex-1">Datas:</span>
                                        <span class="font-semibold text-primary-700">{{ ai_stats.patterns.data }}</span>
                                    </div>
                                </div>
                                <div class="flex flex-col">
                                    <div class="flex items-center mb-2">
                                        <span class="w-3 h-3 bg-accent-400 rounded-full mr-2"></span>
                                        <span class="text-sm flex-1">Horários:</span>
                                        <span class="font-semibold text-primary-700">{{ ai_stats.patterns.horario }}</span>
                                    </div>
                                    <div class="flex items-center mb-2">
                                        <span class="w-3 h-3 bg-accent-500 rounded-full mr-2"></span>
                                        <span class="text-sm flex-1">Litros:</span>
                                        <span class="font-semibold text-primary-700">{{ ai_stats.patterns.litros }}</span>
                                    </div>
                                    <div class="flex items-center mb-2">
                                        <span class="w-3 h-3 bg-accent-600 rounded-full mr-2"></span>
                                        <span class="text-sm flex-1">Quantidade:</span>
                                        <span class="font-semibold text-primary-700">{{ ai_stats.patterns.quantidade }}</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="w-3 h-3 bg-accent-700 rounded-full mr-2"></span>
                                        <span class="text-sm flex-1">Número:</span>
                                        <span class="font-semibold text-primary-700">{{ ai_stats.patterns.numero }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 text-center">
                        <div class="text-sm text-gray-600">
                            A IA melhora continuamente com uso. Cada lista processada aprimora a precisão do sistema.
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Footer -->
            <div class="bg-gray-50 px-6 py-4 text-center text-gray-500 text-sm">
                Léguas Franzinas &copy; 2025 | Sistema de Conversão com IA
            </div>
        </div>
    </div>

</body>
</html>