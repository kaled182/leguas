{% load static %}

{% load custom_filters %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Dados - Converter</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="{% static 'js/geoapivalidator.js' %}"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                            950: '#082f49',
                        },
                        accent: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            200: '#99f6e4',
                            300: '#5eead4',
                            400: '#2dd4bf',
                            500: '#14b8a6',
                            600: '#0d9488',
                            700: '#0f766e',
                            800: '#115e59',
                            900: '#134e4a',
                            950: '#022c22',
                        }
                    }
                }
            }
        }
    </script>
    <!-- Heroicons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class="bg-gradient-to-br from-indigo-500 to-purple-600 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-xl shadow-2xl overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-primary-600 to-primary-800 p-6 text-white">
                <div class="flex flex-wrap items-center justify-between">
                    <div class="w-full md:w-3/4">
                        <h2 class="text-3xl font-bold flex items-center">
                            <i class="bi bi-table mr-3"></i>
                            Lista de Dados Processados
                        </h2>
                        <p class="mt-2 opacity-75">Revise e edite os dados antes de gerar o arquivo XLSX</p>
                    </div>
                    <div class="w-full md:w-1/4 mt-4 md:mt-0 text-right">
                        <a href="/converter/" class="inline-flex items-center px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg font-medium transition-all duration-200">
                            <i class="bi bi-arrow-left mr-2"></i>
                            Voltar
                        </a>
                    </div>
                </div>
            </div>

            <div class="p-6">
                <!-- Estatísticas -->
                <div class="bg-blue-50 rounded-xl p-6 mb-6 shadow-md">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center border-b md:border-b-0 md:border-r border-blue-100 pb-4 md:pb-0">
                            <div class="text-4xl font-bold text-primary-600" id="total-registros">{{ dados|length }}</div>
                            <div class="text-gray-500 font-medium mt-1">Total de Registros</div>
                        </div>
                        <div class="text-center border-b md:border-b-0 md:border-r border-blue-100 pb-4 md:pb-0">
                            <div class="text-4xl font-bold text-primary-600" id="registros-visiveis">{{ dados|length }}</div>
                            <div class="text-gray-500 font-medium mt-1">Registros Visíveis</div>
                        </div>
                        <div class="text-center">
                            <div class="text-4xl font-bold text-accent-500">
                                <i class="bi bi-check-circle"></i>
                            </div>
                            <div class="text-gray-500 font-medium mt-1">Dados Carregados</div>
                        </div>
                    </div>
                </div>
                
                <!-- IA Confidence Report -->
                {% if confidence_report %}
                <div class="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-xl p-6 mb-6 shadow-md">
                    <h3 class="text-lg font-semibold text-primary-700 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        Relatório de Confiança da IA
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Distribuição de Confiança -->
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <h4 class="text-sm font-semibold text-gray-500 uppercase mb-3">Distribuição de Confiança</h4>
                            <div class="flex items-center mb-4">
                                <div class="w-full bg-gray-200 rounded-full h-2.5 mr-2">
                                    {% with high=confidence_report.high_confidence|default:0 %}
                                    {% with med=confidence_report.medium_confidence|default:0 %}
                                    {% with low=confidence_report.low_confidence|default:0 %}
                                    {% with total=high|add:med|add:low %}
                                    {% if total > 0 %}
                                    <div class="bg-green-500 h-2.5 rounded-l-full" style="width: {{ high|floatformat:0 }}%"></div>
                                    <div class="bg-yellow-500 h-2.5" style="width: {{ med|floatformat:0 }}%"></div>
                                    <div class="bg-red-500 h-2.5 rounded-r-full" style="width: {{ low|floatformat:0 }}%"></div>
                                    {% endif %}
                                    {% endwith %}
                                    {% endwith %}
                                    {% endwith %}
                                    {% endwith %}
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-2 text-center">
                                <div>
                                    <div class="text-xl font-bold text-green-600">{{ confidence_report.high_confidence|default:0 }}</div>
                                    <div class="text-xs text-gray-500">Alta Confiança</div>
                                </div>
                                <div>
                                    <div class="text-xl font-bold text-yellow-600">{{ confidence_report.medium_confidence|default:0 }}</div>
                                    <div class="text-xs text-gray-500">Média Confiança</div>
                                </div>
                                <div>
                                    <div class="text-xl font-bold text-red-600">{{ confidence_report.low_confidence|default:0 }}</div>
                                    <div class="text-xs text-gray-500">Baixa Confiança</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Estatísticas de Aprendizado -->
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <h4 class="text-sm font-semibold text-gray-500 uppercase mb-3">Estatísticas de Aprendizado</h4>
                            
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-600">Precisão</span>
                                <div class="flex items-center">
                                    <div class="w-32 bg-gray-200 rounded-full h-2 mr-2">
                                        <div class="bg-primary-600 h-2 rounded-full" style="width: {{ confidence_report.ranking_stats.accuracy|floatformat:0 }}%"></div>
                                    </div>
                                    <span class="text-xs font-medium text-gray-700">{{ confidence_report.ranking_stats.accuracy|floatformat:1 }}%</span>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-500">Padrões aprendidos:</span>
                                    <span class="text-sm font-medium text-primary-700">{{ confidence_report.ranking_stats.patterns_learned }}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-500">Correções feitas:</span>
                                    <span class="text-sm font-medium text-primary-700">{{ confidence_report.ranking_stats.corrections_made }}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-500">Exemplos coletados:</span>
                                    <span class="text-sm font-medium text-primary-700">{{ confidence_report.ranking_stats.examples_collected }}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-500">Total de históricos:</span>
                                    <span class="text-sm font-medium text-primary-700">{{ ai_stats.total_history }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Confiança por campo -->
                    {% if confidence_report.field_averages %}
                    <div class="mt-4 bg-white rounded-lg p-4 shadow-sm overflow-hidden">
                        <h4 class="text-sm font-semibold text-gray-500 uppercase mb-3">Confiança por Campo</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            {% for field, avg in confidence_report.field_averages.items %}
                            <div>
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-xs font-medium text-gray-700 capitalize">{{ field }}</span>
                                    <span class="text-xs text-gray-500">{{ avg|floatformat:2 }}</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-1.5">
                                    <div 
                                        class="h-1.5 rounded-full {% if avg > 0.8 %}bg-green-500{% elif avg > 0.5 %}bg-yellow-500{% else %}bg-red-500{% endif %}"
                                        style="width: {% widthratio avg 1 100 %}%">
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Filtros -->
                <div class="bg-gray-50 rounded-xl p-6 mb-6 shadow-md">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-6 items-end">
                        <div class="md:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="bi bi-funnel mr-1"></i>
                                Filtrar por:
                            </label>
                            <select id="filtro-coluna" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring focus:ring-primary-200 focus:border-primary-500 outline-none transition-all duration-200">
                                <option value="">Todas as colunas</option>
                                <option value="endereco">Endereço</option>
                                <option value="codigo_id">ID</option>
                                <option value="numero">Número</option>
                                <option value="hora">Hora</option>
                                <option value="data">Data</option>
                                <option value="horario">Horário</option>
                                <option value="litros">Litros</option>
                                <option value="quantidade">Quantidade</option>
                            </select>
                        </div>
                        <div class="md:col-span-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="bi bi-search mr-1"></i>
                                Valor:
                            </label>
                            <input type="text" id="filtro-valor" placeholder="Digite para filtrar..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring focus:ring-primary-200 focus:border-primary-500 outline-none transition-all duration-200">
                        </div>
                        <div class="md:col-span-3 flex space-x-2">
                            <button onclick="limparFiltros()" class="flex-1 flex items-center justify-center px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-all duration-200">
                                <i class="bi bi-x-circle mr-2"></i>
                                Limpar
                            </button>
                            <button onclick="adicionarLinha()" class="flex-1 flex items-center justify-center px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg transition-all duration-200">
                                <i class="bi bi-plus-circle mr-2"></i>
                                Adicionar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tabela -->
                <div class="rounded-xl overflow-hidden shadow-lg mb-6 border border-gray-200 max-h-[60vh] overflow-y-auto">
                    <table class="w-full" id="tabela-dados">
                        <thead>
                            <tr class="bg-gradient-to-r from-primary-600 to-primary-700 text-white">
                                <th class="py-3 px-4 text-left w-12">#</th>
                                <th class="py-3 px-4 text-left w-64">Endereço</th>
                                <th class="py-3 px-4 text-left w-36">ID</th>
                                <th class="py-3 px-4 text-left w-20">Número</th>
                                <th class="py-3 px-4 text-left w-20">Hora</th>
                                <th class="py-3 px-4 text-left w-20">Data</th>
                                <th class="py-3 px-4 text-left w-28">Horário</th>
                                <th class="py-3 px-4 text-left w-24">Litros</th>
                                <th class="py-3 px-4 text-left w-24">Quantidade</th>
                                <th class="py-3 px-4 text-left w-24">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="corpo-tabela">
                            {% for item in dados %}
                            <tr data-id="{{ item.id }}" class="border-b border-gray-200 hover:bg-blue-50 transition-colors duration-150">
                                <td class="py-3 px-4 font-medium text-primary-600">{{ item.id }}</td>
                                <td class="py-2 px-4">
                                    <input type="text" value="{{ item.endereco }}" data-field="endereco"
                                    class="w-full px-3 py-1 border border-transparent hover:border-gray-300 focus:border-primary-500 rounded transition-all duration-200 bg-transparent focus:bg-white focus:ring focus:ring-primary-200 outline-none">
                                </td>
                                <td class="py-2 px-4">
                                    <input type="text" value="{{ item.codigo_id }}" data-field="codigo_id"
                                    class="w-full px-3 py-1 border border-transparent hover:border-gray-300 focus:border-primary-500 rounded transition-all duration-200 bg-transparent focus:bg-white focus:ring focus:ring-primary-200 outline-none">
                                </td>
                                <td class="py-2 px-4">
                                    <input type="text" value="{{ item.numero }}" data-field="numero"
                                    class="w-full px-3 py-1 border border-transparent hover:border-gray-300 focus:border-primary-500 rounded transition-all duration-200 bg-transparent focus:bg-white focus:ring focus:ring-primary-200 outline-none">
                                </td>
                                <td class="py-2 px-4">
                                    <input type="text" value="{{ item.hora }}" data-field="hora"
                                    class="w-full px-3 py-1 border border-transparent hover:border-gray-300 focus:border-primary-500 rounded transition-all duration-200 bg-transparent focus:bg-white focus:ring focus:ring-primary-200 outline-none">
                                </td>
                                <td class="py-2 px-4">
                                    <input type="text" value="{{ item.data }}" data-field="data"
                                    class="w-full px-3 py-1 border border-transparent hover:border-gray-300 focus:border-primary-500 rounded transition-all duration-200 bg-transparent focus:bg-white focus:ring focus:ring-primary-200 outline-none">
                                </td>
                                <td class="py-2 px-4">
                                    <input type="text" value="{{ item.horario }}" data-field="horario"
                                    class="w-full px-3 py-1 border border-transparent hover:border-gray-300 focus:border-primary-500 rounded transition-all duration-200 bg-transparent focus:bg-white focus:ring focus:ring-primary-200 outline-none">
                                </td>
                                <td class="py-2 px-4">
                                    <input type="text" value="{{ item.litros }}" data-field="litros"
                                    class="w-full px-3 py-1 border border-transparent hover:border-gray-300 focus:border-primary-500 rounded transition-all duration-200 bg-transparent focus:bg-white focus:ring focus:ring-primary-200 outline-none">
                                </td>
                                <td class="py-2 px-4">
                                    <input type="text" value="{{ item.quantidade }}" data-field="quantidade"
                                    class="w-full px-3 py-1 border border-transparent hover:border-gray-300 focus:border-primary-500 rounded transition-all duration-200 bg-transparent focus:bg-white focus:ring focus:ring-primary-200 outline-none">
                                </td>
                                <td class="py-2 px-4">
                                    <button onclick="removerLinha({{ item.id }})" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors duration-200 text-sm flex items-center">
                                        <i class="bi bi-trash mr-1"></i>
                                        Remover
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Botões de Ação -->
                <div class="sticky bottom-0 bg-white bg-opacity-95 backdrop-blur-sm p-6 rounded-xl shadow-md mt-8">
                    <div class="flex flex-wrap justify-between gap-4">
                        <button onclick="gerarXLSX()" class="flex-grow md:flex-grow-0 px-6 py-3 bg-accent-500 hover:bg-accent-600 text-white font-medium rounded-lg shadow-md transition-all duration-200 flex items-center justify-center">
                            <i class="bi bi-file-earmark-excel mr-2"></i>
                            Gerar Arquivo XLSX
                        </button>
                        <button onclick="ValidarGEOAPI()" class="flex-grow md:flex-grow-0 px-6 py-3 bg-accent-500 hover:bg-accent-600 text-white font-medium rounded-lg shadow-md transition-all duration-200 flex items-center justify-center">
                            <i class="bi bi-file-earmark-excel mr-2"></i>
                            Validar Endereços
                        </button>
                        <button onclick="voltarInicio()" class="flex-grow md:flex-grow-0 px-6 py-3 bg-primary-500 hover:bg-primary-600 text-white font-medium rounded-lg shadow-md transition-all duration-200 flex items-center justify-center">
                            <i class="bi bi-arrow-left mr-2"></i>
                            Nova Lista
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 text-center">
            <div class="animate-spin mx-auto h-12 w-12 border-4 border-primary-500 border-t-transparent rounded-full mb-4"></div>
            <h3 class="text-xl font-medium text-gray-900 mb-2">Gerando arquivo XLSX...</h3>
            <p class="text-gray-500">Por favor, aguarde um momento.</p>
        </div>
    </div>

    <script>
        let proximoId = {{ dados|length|add:1 }};

        // Filtros
        document.getElementById('filtro-valor').addEventListener('input', aplicarFiltros);
        document.getElementById('filtro-coluna').addEventListener('change', aplicarFiltros);

        function aplicarFiltros() {
            const coluna = document.getElementById('filtro-coluna').value;
            const valor = document.getElementById('filtro-valor').value.toLowerCase();
            const linhas = document.querySelectorAll('#corpo-tabela tr');
            let visiveis = 0;

            linhas.forEach(linha => {
                let mostrar = true;

                if (valor) {
                    if (coluna) {
                        const input = linha.querySelector(`input[data-field="${coluna}"]`);
                        const texto = input ? input.value.toLowerCase() : '';
                        mostrar = texto.includes(valor);
                    } else {
                        const inputs = linha.querySelectorAll('input');
                        mostrar = Array.from(inputs).some(input => 
                            input.value.toLowerCase().includes(valor)
                        );
                    }
                }

                linha.style.display = mostrar ? '' : 'none';
                if (mostrar) visiveis++;
            });

            document.getElementById('registros-visiveis').textContent = visiveis;
        }

        function limparFiltros() {
            document.getElementById('filtro-coluna').value = '';
            document.getElementById('filtro-valor').value = '';
            aplicarFiltros();
        }

        function adicionarLinha() {
            const tbody = document.getElementById('corpo-tabela');
            const novaLinha = document.createElement('tr');
            novaLinha.setAttribute('data-id', proximoId);
            novaLinha.className = 'border-b border-gray-200 hover:bg-blue-50 transition-colors duration-150';
            
            novaLinha.innerHTML = `
                <td class="py-3 px-4 font-medium text-primary-600">${proximoId}</td>
                <td class="py-2 px-4">
                    <input type="text" value="" data-field="endereco"
                    class="w-full px-3 py-1 border border-transparent hover:border-gray-300 focus:border-primary-500 rounded transition-all duration-200 bg-transparent focus:bg-white focus:ring focus:ring-primary-200 outline-none">
                </td>
                <td class="py-2 px-4">
                    <input type="text" value="" data-field="codigo_id"
                    class="w-full px-3 py-1 border border-transparent hover:border-gray-300 focus:border-primary-500 rounded transition-all duration-200 bg-transparent focus:bg-white focus:ring focus:ring-primary-200 outline-none">
                </td>
                <td class="py-2 px-4">
                    <input type="text" value="" data-field="numero"
                    class="w-full px-3 py-1 border border-transparent hover:border-gray-300 focus:border-primary-500 rounded transition-all duration-200 bg-transparent focus:bg-white focus:ring focus:ring-primary-200 outline-none">
                </td>
                <td class="py-2 px-4">
                    <input type="text" value="" data-field="hora"
                    class="w-full px-3 py-1 border border-transparent hover:border-gray-300 focus:border-primary-500 rounded transition-all duration-200 bg-transparent focus:bg-white focus:ring focus:ring-primary-200 outline-none">
                </td>
                <td class="py-2 px-4">
                    <input type="text" value="" data-field="data"
                    class="w-full px-3 py-1 border border-transparent hover:border-gray-300 focus:border-primary-500 rounded transition-all duration-200 bg-transparent focus:bg-white focus:ring focus:ring-primary-200 outline-none">
                </td>
                <td class="py-2 px-4">
                    <input type="text" value="" data-field="horario"
                    class="w-full px-3 py-1 border border-transparent hover:border-gray-300 focus:border-primary-500 rounded transition-all duration-200 bg-transparent focus:bg-white focus:ring focus:ring-primary-200 outline-none">
                </td>
                <td class="py-2 px-4">
                    <input type="text" value="" data-field="litros"
                    class="w-full px-3 py-1 border border-transparent hover:border-gray-300 focus:border-primary-500 rounded transition-all duration-200 bg-transparent focus:bg-white focus:ring focus:ring-primary-200 outline-none">
                </td>
                <td class="py-2 px-4">
                    <input type="text" value="" data-field="quantidade"
                    class="w-full px-3 py-1 border border-transparent hover:border-gray-300 focus:border-primary-500 rounded transition-all duration-200 bg-transparent focus:bg-white focus:ring focus:ring-primary-200 outline-none">
                </td>
                <td class="py-2 px-4">
                    <button onclick="removerLinha(${proximoId})" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors duration-200 text-sm flex items-center">
                        <i class="bi bi-trash mr-1"></i>
                        Remover
                    </button>
                </td>
            `;
            
            tbody.appendChild(novaLinha);
            proximoId++;
            atualizarEstatisticas();
            
            // Aplicar animação na nova linha
            novaLinha.style.opacity = '0';
            novaLinha.style.transform = 'translateY(20px)';
            setTimeout(() => {
                novaLinha.style.transition = 'all 0.3s ease';
                novaLinha.style.opacity = '1';
                novaLinha.style.transform = 'translateY(0)';
            }, 10);
        }

        function removerLinha(id) {
            const linha = document.querySelector(`tr[data-id="${id}"]`);
            if (linha && confirm('Tem certeza que deseja remover esta linha?')) {
                // Animação de saída
                linha.style.transition = 'all 0.3s ease';
                linha.style.opacity = '0';
                linha.style.transform = 'translateX(20px)';
                
                setTimeout(() => {
                    linha.remove();
                    atualizarEstatisticas();
                    aplicarFiltros();
                }, 300);
            }
        }

        function atualizarEstatisticas() {
            const total = document.querySelectorAll('#corpo-tabela tr').length;
            document.getElementById('total-registros').textContent = total;
        }

        function coletarDados() {
            const dados = [];
            const linhas = document.querySelectorAll('#corpo-tabela tr');
            
            linhas.forEach((linha, index) => {
                const inputs = linha.querySelectorAll('input');
                const item = {
                    id: index + 1,
                    endereco: inputs[0].value,
                    codigo_id: inputs[1].value,
                    numero: inputs[2].value,
                    hora: inputs[3].value,
                    data: inputs[4].value,
                    horario: inputs[5].value,
                    litros: inputs[6].value,
                    quantidade: inputs[7].value
                };
                dados.push(item);
            });
            
            return dados;
        }

        function gerarXLSX() {
            const dados = coletarDados();
            
            if (dados.length === 0) {
                alert('Não há dados para exportar!');
                return;
            }

            const modal = document.getElementById('loadingModal');
            modal.classList.remove('hidden');

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/converter/';
            
            // CSRF Token
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = '{{ csrf_token }}';
            form.appendChild(csrfInput);
            
            // Action
            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = 'generate_xlsx';
            form.appendChild(actionInput);
            
            // Dados
            const dadosInput = document.createElement('input');
            dadosInput.type = 'hidden';
            dadosInput.name = 'dados_editados';
            dadosInput.value = JSON.stringify(dados);
            form.appendChild(dadosInput);
            
            document.body.appendChild(form);
            
            setTimeout(() => {
                form.submit();
                modal.classList.add('hidden');
                document.body.removeChild(form);
            }, 1000);
        }

        function voltarInicio() {
            if (confirm('Tem certeza que deseja voltar? Os dados editados serão perdidos.')) {
                window.location.href = '/converter/';
            }
        }

        // Efeitos visuais
        document.addEventListener('DOMContentLoaded', function() {
            // Animação de entrada das linhas
            const linhas = document.querySelectorAll('#corpo-tabela tr');
            linhas.forEach((linha, index) => {
                linha.style.opacity = '0';
                linha.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    linha.style.transition = 'all 0.3s ease';
                    linha.style.opacity = '1';
                    linha.style.transform = 'translateY(0)';
                }, index * 50);
            });
        });
    </script>
</body>
</html>
