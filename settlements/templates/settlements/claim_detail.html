{% extends 'settlements/base.html' %}

{% block title %}Reclamação #{{ claim.id }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">
  <!-- Header com Título e Ações -->
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200/50 dark:border-gray-700/50 p-6 fade-in">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div class="flex items-start gap-4">
        <div class="flex-shrink-0">
          <div class="w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-xl flex items-center justify-center">
            <i data-lucide="alert-circle" class="w-6 h-6 text-red-600 dark:text-red-400"></i>
          </div>
        </div>
        <div>
          <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-1">
            Reclamação #{{ claim.id }}
          </h1>
          <p class="text-sm text-gray-500 dark:text-gray-400">
            <a href="{% url 'claim-list' %}" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
              ← Voltar para Reclamações
            </a>
          </p>
        </div>
      </div>
      <div class="flex flex-wrap gap-3">
        {% if claim.status == 'PENDING' %}
        <button class="inline-flex items-center px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium transition-colors duration-200 gap-2">
          <i data-lucide="check" class="w-4 h-4"></i>
          Aprovar
        </button>
        <button class="inline-flex items-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors duration-200 gap-2">
          <i data-lucide="x" class="w-4 h-4"></i>
          Rejeitar
        </button>
        {% endif %}
        {% if claim.status == 'APPROVED' and not claim.settlement %}
        <button class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors duration-200 gap-2">
          <i data-lucide="unlink" class="w-4 h-4"></i>
          Recorrer
        </button>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Grid Principal -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Coluna Esquerda: Informações Principais -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Card Status e Informações -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200/50 dark:border-gray-700/50 p-6 slide-in">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
          <i data-lucide="info" class="w-5 h-5 text-red-600 dark:text-red-400"></i>
          Informações da Reclamação
        </h2>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</label>
            <div class="mt-1">
              {% if claim.status == 'APPROVED' %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400">
                  <i data-lucide="check-circle" class="w-4 h-4 mr-1"></i>
                  Aprovado
                </span>
              {% elif claim.status == 'PENDING' %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400">
                  <i data-lucide="clock" class="w-4 h-4 mr-1"></i>
                  Pendente
                </span>
              {% elif claim.status == 'REJECTED' %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400">
                  <i data-lucide="x-circle" class="w-4 h-4 mr-1"></i>
                  Rejeitado
                </span>
              {% elif claim.status == 'APPEALED' %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400">
                  <i data-lucide="rotate-ccw" class="w-4 h-4 mr-1"></i>
                  Em Recurso
                </span>
              {% else %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                  {{ claim.get_status_display }}
                </span>
              {% endif %}
            </div>
          </div>
          <div>
            <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Motorista</label>
            <p class="mt-1 text-sm font-semibold text-gray-900 dark:text-white">{{ claim.driver.nome_completo }}</p>
          </div>
          <div>
            <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Tipo</label>
            <p class="mt-1 text-sm text-gray-900 dark:text-white">{{ claim.get_claim_type_display }}</p>
          </div>
          <div>
            <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Valor</label>
            <p class="mt-1 text-xl font-bold text-red-600 dark:text-red-400">€{{ claim.amount|floatformat:2 }}</p>
          </div>
          <div>
            <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Data do Ocorrido</label>
            <p class="mt-1 text-sm text-gray-900 dark:text-white">{{ claim.occurred_at|date:"d/m/Y H:i" }}</p>
          </div>
          {% if claim.settlement %}
          <div>
            <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Liquidação</label>
            <p class="mt-1 text-sm">
              <a href="{% url 'settlement-detail' claim.settlement.id %}" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium">
                #{{ claim.settlement.id }}
              </a>
            </p>
          </div>
          {% endif %}
        </div>
        
        {% if claim.order %}
        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
          <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Pedido Relacionado</label>
          <p class="mt-1 text-sm">
            <a href="/admin/orders_manager/order/{{ claim.order.id }}/change/" target="_blank" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium">
              {{ claim.order.tracking_code|default:"#"|add:claim.order.id|stringformat:"s" }}
            </a>
          </p>
        </div>
        {% endif %}
        
        {% if claim.vehicle_incident %}
        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
          <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Incidente de Veículo</label>
          <p class="mt-1 text-sm">
            <a href="/admin/fleet_management/vehicleincident/{{ claim.vehicle_incident.id }}/change/" target="_blank" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium">
              #{{ claim.vehicle_incident.id }}
            </a>
          </p>
        </div>
        {% endif %}
      </div>

      <!-- Card Descrição -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200/50 dark:border-gray-700/50 p-6 scale-in">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
          <i data-lucide="file-text" class="w-5 h-5 text-red-600 dark:text-red-400"></i>
          Descrição
        </h2>
        <div class="prose dark:prose-invert max-w-none">
          <p class="text-gray-700 dark:text-gray-300 whitespace-pre-line">{{ claim.description }}</p>
        </div>
        
        {% if claim.evidence_file %}
        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
          <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2 block">Evidência</label>
          <a href="{{ claim.evidence_file.url }}" target="_blank" class="inline-flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-900 dark:text-white rounded-lg font-medium transition-colors duration-200 gap-2">
            <i data-lucide="paperclip" class="w-4 h-4"></i>
            Ver Arquivo Anexado
          </a>
        </div>
        {% endif %}
      </div>

      <!-- Card Justificativa do Motorista -->
      {% if claim.justification %}
      <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl shadow-sm p-6 slide-in">
        <h2 class="text-lg font-semibold text-amber-900 dark:text-amber-300 mb-4 flex items-center gap-2">
          <i data-lucide="message-square" class="w-5 h-5"></i>
          Justificativa do Motorista
        </h2>
        <div class="prose dark:prose-invert max-w-none">
          <p class="text-amber-800 dark:text-amber-200 whitespace-pre-line">{{ claim.justification }}</p>
        </div>
      </div>
      {% endif %}

      <!-- Card Revisão -->
      {% if claim.reviewed_by %}
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200/50 dark:border-gray-700/50 p-6 slide-in">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
          <i data-lucide="clipboard-check" class="w-5 h-5 text-blue-600 dark:text-blue-400"></i>
          Revisão
        </h2>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Revisado por</label>
            <p class="mt-1 text-sm font-semibold text-gray-900 dark:text-white">
              {{ claim.reviewed_by.get_full_name|default:claim.reviewed_by.username }}
            </p>
          </div>
          <div>
            <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Data da Revisão</label>
            <p class="mt-1 text-sm text-gray-900 dark:text-white">{{ claim.reviewed_at|date:"d/m/Y H:i" }}</p>
          </div>
        </div>
        {% if claim.review_notes %}
        <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
          <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2 block">Notas da Revisão</label>
          <p class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-line">{{ claim.review_notes }}</p>
        </div>
        {% endif %}
      </div>
      {% endif %}
    </div>

    <!-- Coluna Direita: Cards Resumo -->
    <div class="space-y-6">
      <!-- Card Valor -->
      <div class="bg-gradient-to-br from-red-600 to-red-700 dark:from-red-700 dark:to-red-800 rounded-xl shadow-sm p-6 text-white scale-in">
        <h3 class="text-sm font-medium opacity-90 mb-4">Valor da Reclamação</h3>
        <div class="space-y-4">
          <div>
            <p class="text-xs opacity-75 mb-1">Valor a Deduzir</p>
            <p class="text-4xl font-bold">€{{ claim.amount|floatformat:2 }}</p>
          </div>
          <div class="pt-4 border-t border-red-500/30">
            <p class="text-xs opacity-75 mb-1">Tipo</p>
            <p class="text-lg font-semibold">{{ claim.get_claim_type_display }}</p>
          </div>
          {% if claim.settlement %}
          <div class="pt-4 border-t border-red-500/30">
            <p class="text-xs opacity-75 mb-1">Status</p>
            <p class="text-lg font-semibold">Aplicado na Liquidação</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Card Timeline -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200/50 dark:border-gray-700/50 p-6 slide-in">
        <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
          <i data-lucide="calendar" class="w-4 h-4 text-red-600 dark:text-red-400"></i>
          Linha do Tempo
        </h3>
        <div class="space-y-4">
          <div class="flex gap-3">
            <div class="flex-shrink-0 w-2 h-2 mt-2 rounded-full bg-blue-600 dark:bg-blue-400"></div>
            <div class="flex-1 min-w-0">
              <p class="text-xs font-medium text-gray-900 dark:text-white">Criada</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">{{ claim.created_at|date:"d/m/Y H:i" }}</p>
              {% if claim.created_by %}
              <p class="text-xs text-gray-400 dark:text-gray-500">por {{ claim.created_by.get_full_name|default:claim.created_by.username }}</p>
              {% endif %}
            </div>
          </div>
          <div class="flex gap-3">
            <div class="flex-shrink-0 w-2 h-2 mt-2 rounded-full bg-red-600 dark:bg-red-400"></div>
            <div class="flex-1 min-w-0">
              <p class="text-xs font-medium text-gray-900 dark:text-white">Ocorrido</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">{{ claim.occurred_at|date:"d/m/Y H:i" }}</p>
            </div>
          </div>
          {% if claim.reviewed_at %}
          <div class="flex gap-3">
            <div class="flex-shrink-0 w-2 h-2 mt-2 rounded-full {% if claim.status == 'APPROVED' %}bg-emerald-600 dark:bg-emerald-400{% else %}bg-red-600 dark:bg-red-400{% endif %}"></div>
            <div class="flex-1 min-w-0">
              <p class="text-xs font-medium text-gray-900 dark:text-white">Revisada</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">{{ claim.reviewed_at|date:"d/m/Y H:i" }}</p>
              <p class="text-xs {% if claim.status == 'APPROVED' %}text-emerald-600 dark:text-emerald-400{% else %}text-red-600 dark:text-red-400{% endif %} font-semibold">
                {{ claim.get_status_display }}
              </p>
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Card Auditoria -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200/50 dark:border-gray-700/50 p-6 slide-in">
        <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
          <i data-lucide="shield" class="w-4 h-4 text-red-600 dark:text-red-400"></i>
          Auditoria
        </h3>
        <div class="space-y-3 text-xs">
          <div>
            <p class="text-gray-500 dark:text-gray-400">ID</p>
            <p class="text-gray-900 dark:text-white font-medium mt-0.5">#{{ claim.id }}</p>
          </div>
          <div>
            <p class="text-gray-500 dark:text-gray-400">Criada em</p>
            <p class="text-gray-900 dark:text-white font-medium mt-0.5">{{ claim.created_at|date:"d/m/Y H:i" }}</p>
          </div>
          {% if claim.created_by %}
          <div>
            <p class="text-gray-500 dark:text-gray-400">Criada por</p>
            <p class="text-gray-900 dark:text-white font-medium mt-0.5">{{ claim.created_by.get_full_name|default:claim.created_by.username }}</p>
          </div>
          {% endif %}
          <div>
            <p class="text-gray-500 dark:text-gray-400">Última atualização</p>
            <p class="text-gray-900 dark:text-white font-medium mt-0.5">{{ claim.updated_at|date:"d/m/Y H:i" }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  });
</script>
{% endblock %}
