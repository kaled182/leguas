{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard Financeiro{% endblock %}

{% block content %}
<div class="p-4 lg:p-8">
  <div class="max-w-7xl mx-auto space-y-8">
    {% include 'settlements/partials/financial_header.html' with title="Sistema Financeiro" description="Gestão de invoices, settlements e claims" %}
    {% include 'settlements/partials/financial_tabs.html' with active='dashboard' %}
  
  <!-- KPIs Grid (padronizado) -->
  <div class="dashboard-cards-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 transition-opacity duration-300" id="dashboard-grid">
    {% include 'settlements/partials/financial_card.html' with card_id="invoices-pending" icon="file-text" color="blue" title="Invoices Pendentes" value=invoices_stats.pending_count description="Aguardando pagamento" suffix="" %}
    {% include 'settlements/partials/financial_card.html' with card_id="invoices-overdue" icon="alert-circle" color="red" title="Invoices Vencidos" value=invoices_stats.overdue_count description="Pagamentos atrasados" suffix="" %}
    {% include 'settlements/partials/financial_card.html' with card_id="settlements-pending" icon="credit-card" color="green" title="Settlements Pendentes" value=settlements_stats.pending_count description="Aguardando repasse" suffix="" %}
    {% include 'settlements/partials/financial_card.html' with card_id="claims-pending" icon="file-warning" color="yellow" title="Claims Pendentes" value=claims_stats.pending_count description="Descontos a revisar" suffix="" %}
  </div>
  
  <!-- Content Grid -->
  <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
    <!-- Recent Invoices -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200/50 dark:border-gray-700/50">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Invoices Recentes</h2>
      </div>
      <div class="p-6">
        {% if recent_invoices %}
          <div class="space-y-4">
            {% for invoice in recent_invoices %}
            <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg hover:shadow-md transition-shadow">
              <div class="flex-1">
                <div class="font-medium text-gray-900 dark:text-white">{{ invoice.partner.name }}</div>
                <div class="text-sm text-gray-500 dark:text-gray-400">
                  {{ invoice.period_start|date:"d/m/Y" }} - {{ invoice.period_end|date:"d/m/Y" }}
                </div>
              </div>
              <div class="text-right">
                <div class="font-bold text-gray-900 dark:text-white">€{{ invoice.total_amount|floatformat:2 }}</div>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                  {% if invoice.status == 'PAID' %}bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400
                  {% elif invoice.status == 'OVERDUE' %}bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400
                  {% elif invoice.status == 'PENDING' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400
                  {% else %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-400{% endif %}">
                  {{ invoice.get_status_display }}
                </span>
              </div>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Nenhum invoice registrado</p>
          </div>
        {% endif %}
      </div>
    </div>
    
    <!-- Pending Claims -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200/50 dark:border-gray-700/50">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Claims Pendentes</h2>
      </div>
      <div class="p-6">
        {% if pending_claims %}
          <div class="space-y-4">
            {% for claim in pending_claims %}
            <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg hover:shadow-md transition-shadow">
              <div class="flex-1">
                <div class="font-medium text-gray-900 dark:text-white">
                  {{ claim.driver.user.get_full_name|default:claim.driver.user.username }}
                </div>
                <div class="text-sm text-gray-500 dark:text-gray-400">
                  {{ claim.get_claim_type_display }}
                </div>
              </div>
              <div class="text-right">
                <div class="font-bold text-gray-900 dark:text-white">
                  {% if claim.amount %}€{{ claim.amount|floatformat:2 }}{% else %}---{% endif %}
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400">{{ claim.created_at|date:"d/m/Y" }}</div>
              </div>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Nenhum claim pendente</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Inicializar ícones Lucide
  if (typeof lucide !== 'undefined') {
    lucide.createIcons();
  }
</script>
{% endblock %}
