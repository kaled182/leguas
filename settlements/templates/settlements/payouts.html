{% extends "settlements/base.html" %}

{% block subtitle %}Pagamentos{% endblock %}

{% block settlements_content %}
<div class="card">
  <div class="card-header">
    <h1 class="card-title">Pagamentos</h1>
  </div>
  
  <div class="filters">
    <h3>Filtros</h3>
    <div class="form-group">
      <label for="date-from">Data Inicial:</label>
      <input type="date" id="date-from" class="form-control" value="{{ request.GET.date_from }}">
    </div>
    <div class="form-group">
      <label for="date-to">Data Final:</label>
      <input type="date" id="date-to" class="form-control" value="{{ request.GET.date_to }}">
    </div>
    <div class="form-group">
      <label for="client">Cliente:</label>
      <select id="client" class="form-control">
        <option value="">Todos</option>
        <option value="Paack" {% if request.GET.client == 'Paack' %}selected{% endif %}>Paack</option>
        <option value="Delnext" {% if request.GET.client == 'Delnext' %}selected{% endif %}>Delnext</option>
      </select>
    </div>
    <div class="form-group">
      <label for="area">Área:</label>
      <input type="text" id="area" class="form-control" value="{{ request.GET.area }}">
    </div>
    <button class="btn" onclick="applyFilters()">Aplicar Filtros</button>
    <button class="btn btn-secondary" onclick="downloadCSV()">Exportar CSV</button>
  </div>
  
  <div class="table-responsive">
    <table class="table" id="payouts-table">
      <thead>
        <tr>
          <th>Motorista</th>
          <th>Período Inicial</th>
          <th>Período Final</th>
          <th>Entregas</th>
          <th>Bruto (Pacotes)</th>
          <th>Bônus</th>
          <th>Fixo</th>
          <th>Bruto Total</th>
          <th>Descontos</th>
          <th>Líquido</th>
          <th>Média/Pacote</th>
        </tr>
      </thead>
      <tbody>
        <!-- Os dados serão preenchidos via JavaScript -->
      </tbody>
      <tfoot>
        <tr>
          <td colspan="3"><strong>TOTAIS</strong></td>
          <td id="total-entregues">0</td>
          <td id="total-bruto-pkg">€0,00</td>
          <td id="total-bonus">€0,00</td>
          <td id="total-fixo">€0,00</td>
          <td id="total-bruto">€0,00</td>
          <td id="total-descontos">€0,00</td>
          <td id="total-liquido">€0,00</td>
          <td id="media-geral">€0,00</td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
  // Função para formatar valores monetários
  function formatCurrency(value) {
    return new Intl.NumberFormat('pt-PT', { style: 'currency', currency: 'EUR' }).format(value);
  }
  
  // Função para formatar datas
  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('pt-PT');
  }
  
  // Função para carregar os dados de pagamentos
  function loadPayoutsData() {
    const dateFrom = document.getElementById('date-from').value;
    const dateTo = document.getElementById('date-to').value;
    const client = document.getElementById('client')?.value || '';
    const area = document.getElementById('area')?.value || '';
    
    if (!dateFrom || !dateTo) {
      alert('Data inicial e final são obrigatórios');
      return;
    }
    
    let url = '{% url "settlements-payouts" %}?';
    if (dateFrom) url += `date_from=${dateFrom}&`;
    if (dateTo) url += `date_to=${dateTo}&`;
    if (client) url += `client=${encodeURIComponent(client)}&`;
    if (area) url += `area=${encodeURIComponent(area)}&`;
    
    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error('Erro na requisição');
        }
        return response.json();
      })
      .then(data => {
        const tbody = document.querySelector('#payouts-table tbody');
        tbody.innerHTML = '';
        
        // Totais para o footer da tabela
        let totalEntregues = 0;
        let totalBrutoPkg = 0;
        let totalBonus = 0;
        let totalFixo = 0;
        let totalBruto = 0;
        let totalDescontos = 0;
        let totalLiquido = 0;
        
        data.forEach(payout => {
          const row = document.createElement('tr');
          
          row.innerHTML = `
            <td>${payout.driver}</td>
            <td>${formatDate(payout.period_from)}</td>
            <td>${formatDate(payout.period_to)}</td>
            <td>${payout.entregues}</td>
            <td>${formatCurrency(payout.bruto_pkg)}</td>
            <td>${formatCurrency(payout.bonus)}</td>
            <td>${formatCurrency(payout.fixo)}</td>
            <td>${formatCurrency(payout.bruto_total)}</td>
            <td>${formatCurrency(payout.descontos)}</td>
            <td>${formatCurrency(payout.liquido)}</td>
            <td>${formatCurrency(payout.media_liq_por_pacote)}</td>
          `;
          
          tbody.appendChild(row);
          
          // Acumular totais
          totalEntregues += payout.entregues;
          totalBrutoPkg += payout.bruto_pkg;
          totalBonus += payout.bonus;
          totalFixo += payout.fixo;
          totalBruto += payout.bruto_total;
          totalDescontos += payout.descontos;
          totalLiquido += payout.liquido;
        });
        
        // Atualizar os totais no footer
        document.getElementById('total-entregues').innerText = totalEntregues;
        document.getElementById('total-bruto-pkg').innerText = formatCurrency(totalBrutoPkg);
        document.getElementById('total-bonus').innerText = formatCurrency(totalBonus);
        document.getElementById('total-fixo').innerText = formatCurrency(totalFixo);
        document.getElementById('total-bruto').innerText = formatCurrency(totalBruto);
        document.getElementById('total-descontos').innerText = formatCurrency(totalDescontos);
        document.getElementById('total-liquido').innerText = formatCurrency(totalLiquido);
        document.getElementById('media-geral').innerText = formatCurrency(totalEntregues > 0 ? totalLiquido / totalEntregues : 0);
      })
      .catch(error => {
        console.error('Erro ao carregar dados:', error);
        alert('Erro ao carregar dados. Verifique se as datas estão preenchidas corretamente.');
      });
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    // Carregar dados se as datas estiverem preenchidas
    const dateFrom = document.getElementById('date-from').value;
    const dateTo = document.getElementById('date-to').value;
    if (dateFrom && dateTo) {
      loadPayoutsData();
    }
  });
</script>
{% endblock %}
