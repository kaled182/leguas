{% extends "settlements/base.html" %}
{% load static %}

{% block subtitle %}Settlement #{{ settlement.id }}{% endblock %}

{% block settlements_content %}
<!-- Header -->
<div class="mb-6">
  <div class="flex justify-between items-center">
    <div>
      <a href="{% url 'settlement-list' %}" class="text-blue-600 hover:text-blue-900 text-sm mb-2 inline-block">
        ← Voltar para lista
      </a>
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
        Settlement #{{ settlement.id }}
      </h1>
      <p class="mt-2 text-gray-600 dark:text-gray-400">
        {{ settlement.driver.user.get_full_name }} • 
        {% if settlement.period_type == 'WEEKLY' %}Semana {{ settlement.week_number }}{% else %}Mês {{ settlement.month_number }}{% endif %}/{{ settlement.year }}
      </p>
    </div>
    <div class="flex space-x-3">
      <a href="{% url 'settlement-pdf' settlement.id %}" class="btn">
        <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
        </svg>
        Download PDF
      </a>
      <a href="/admin/settlements/driversettlement/{{ settlement.id }}/change/" class="btn btn-secondary">
        <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
        </svg>
        Editar
      </a>
    </div>
  </div>
</div>

<!-- Main Info Grid -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
  <!-- Status Card -->
  <div class="card">
    <div class="card-body">
      <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Status</h3>
      <span class="inline-flex px-3 py-2 text-sm font-semibold rounded-full 
        {% if settlement.status == 'PAID' %}bg-green-100 text-green-800
        {% elif settlement.status == 'APPROVED' %}bg-blue-100 text-blue-800
        {% elif settlement.status == 'CALCULATED' %}bg-yellow-100 text-yellow-800
        {% else %}bg-gray-100 text-gray-800{% endif %}">
        {{ settlement.get_status_display }}
      </span>
      <div class="mt-4">
        <p class="text-xs text-gray-500 dark:text-gray-400">Período</p>
        <p class="text-sm font-medium text-gray-900 dark:text-white">
          {{ settlement.period_start|date:"d/m/Y" }} - {{ settlement.period_end|date:"d/m/Y" }}
        </p>
      </div>
      {% if settlement.partner %}
      <div class="mt-3">
        <p class="text-xs text-gray-500 dark:text-gray-400">Partner</p>
        <p class="text-sm font-medium text-gray-900 dark:text-white">{{ settlement.partner.name }}</p>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Performance Card -->
  <div class="card">
    <div class="card-body">
      <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-3">Performance</h3>
      <div class="space-y-3">
        <div>
          <p class="text-xs text-gray-500 dark:text-gray-400">Total Entregas</p>
          <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ settlement.total_deliveries }}</p>
        </div>
        <div>
          <p class="text-xs text-gray-500 dark:text-gray-400">Taxa de Sucesso</p>
          <p class="text-2xl font-bold {% if settlement.success_rate >= 95 %}text-green-600{% elif settlement.success_rate >= 85 %}text-yellow-600{% else %}text-red-600{% endif %}">
            {{ settlement.success_rate|floatformat:1 }}%
          </p>
        </div>
        <div>
          <p class="text-xs text-gray-500 dark:text-gray-400">Entregas com Sucesso</p>
          <p class="text-lg font-semibold text-gray-900 dark:text-white">{{ settlement.successful_deliveries }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Financial Summary Card -->
  <div class="card">
    <div class="card-body">
      <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-3">Resumo Financeiro</h3>
      <div class="space-y-2">
        <div class="flex justify-between">
          <span class="text-sm text-gray-600 dark:text-gray-400">Valor Bruto</span>
          <span class="text-sm font-medium text-gray-900 dark:text-white">€{{ settlement.gross_amount|floatformat:2 }}</span>
        </div>
        <div class="flex justify-between text-green-600">
          <span class="text-sm">+ Bônus Performance</span>
          <span class="text-sm font-medium">€{{ settlement.bonus_amount|floatformat:2 }}</span>
        </div>
        <div class="flex justify-between text-red-600">
          <span class="text-sm">- Combustível</span>
          <span class="text-sm font-medium">€{{ settlement.fuel_cost|floatformat:2 }}</span>
        </div>
        <div class="flex justify-between text-red-600">
          <span class="text-sm">- Claims</span>
          <span class="text-sm font-medium">€{{ settlement.claims_total|floatformat:2 }}</span>
        </div>
        <div class="flex justify-between text-red-600">
          <span class="text-sm">- Outros Descontos</span>
          <span class="text-sm font-medium">€{{ settlement.other_deductions|floatformat:2 }}</span>
        </div>
        <div class="border-t border-gray-200 dark:border-gray-700 pt-2 mt-2">
          <div class="flex justify-between">
            <span class="text-base font-semibold text-gray-900 dark:text-white">Líquido</span>
            <span class="text-base font-bold text-green-600">€{{ settlement.net_amount|floatformat:2 }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Claims Section -->
{% if settlement.claims.all %}
<div class="card mb-8">
  <div class="card-header">
    <h3 class="card-title">Claims Aplicados ({{ settlement.claims.count }})</h3>
  </div>
  <div class="card-body">
    <div class="overflow-x-auto">
      <table class="data-table">
        <thead>
          <tr>
            <th>Data</th>
            <th>Tipo</th>
            <th>Descrição</th>
            <th>Valor</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for claim in settlement.claims.all %}
          <tr>
            <td>{{ claim.created_at|date:"d/m/Y" }}</td>
            <td>
              <span class="text-xs font-medium px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded">
                {{ claim.get_claim_type_display }}
              </span>
            </td>
            <td>{{ claim.description|truncatewords:15 }}</td>
            <td class="font-semibold text-red-600">€{{ claim.amount|floatformat:2 }}</td>
            <td>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                {{ claim.get_status_display }}
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

<!-- Related Orders -->
<div class="card">
  <div class="card-header">
    <h3 class="card-title">Pedidos do Período</h3>
    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
      {{ orders_stats.total }} total • {{ orders_stats.delivered }} entregues • {{ orders_stats.failed }} falhados
    </p>
  </div>
  <div class="card-body">
    {% if related_orders %}
    <div class="overflow-x-auto">
      <table class="data-table">
        <thead>
          <tr>
            <th>Data</th>
            <th>Código</th>
            <th>Partner</th>
            <th>Zona</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for order in related_orders %}
          <tr>
            <td>{{ order.created_at|date:"d/m/Y H:i" }}</td>
            <td>
              <a href="/admin/orders_manager/order/{{ order.id }}/change/" class="text-blue-600 hover:text-blue-900">
                {{ order.tracking_code }}
              </a>
            </td>
            <td>{{ order.partner.name }}</td>
            <td>{{ order.delivery_postal_code|default:"-" }}</td>
            <td>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                {% if order.status == 'DELIVERED' %}bg-green-100 text-green-800
                {% elif order.status == 'CANCELLED' or order.status == 'FAILED' %}bg-red-100 text-red-800
                {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                {{ order.get_status_display }}
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% if related_orders|length == 50 %}
    <p class="text-xs text-gray-500 dark:text-gray-400 mt-3 text-center">
      Mostrando apenas os primeiros 50 pedidos...
    </p>
    {% endif %}
    {% else %}
    <p class="text-gray-500 dark:text-gray-400 text-center py-4">Nenhum pedido encontrado neste período</p>
    {% endif %}
  </div>
</div>
{% endblock %}
